# データの整形と正規表現について

文字列の抽出や置き換え等の作業に欠かせないのが正規表現です。
スクレピングしたデータを使える形式に整形する際は、正規表現を利用するとスマートに整える事ができます。

## 正規表現とは

正規表現とは、文字列のパターンを表現する表記方法のことです。
文字列の検索や置き換えを行う際にかつやくします。
文字列の集合を「メタ文字」と呼ばれると個別な意味を持った記号を組み合わせて表現し、文字を検索したり、置き換えを行ったりします。

## JavaScript に置ける正規表現の使い方

JavaScript ではソースコード中へ「`/パターン/`」の様に書くことで、正規表現オブジェクトを生成できます。
これを「正規表現リテラル」と言います。
正規表現リテラルを使うと、スクリプトが評価されるタイミングで正規表現がコンパイルされるので、パフォーマンスがよくなります。
これに対して「RegExpオブジェクト」を使う方法もあります。
RegExpオブジェクトを使えば、文字列(String型)の値で正規表現パターンを指定することができます。
そのため、動的に正規表現文字列を生成することが可能です。

### 正規表現メソッド

JavaScript の正規表現では、次のメソッドが利用できます。

| メソッド名 | 説明 |
|:--------|:-------|
| exec    | 文字列中で一致するものを検索します。結果情報の配列を返します。検索に失敗した場合、null を返します。**RegExp** のメソッド |
| test    | 文字列中で一致するものがあるかどうかテストします。true/false のいずれかを返します。**RegExp** のメソッド |
| match   | 文字列中で一致するものを検索します。結果情報の配列を返します。マッチしない場合、null を返します。**String** のメソッド |
| search  | 文字列中で一致するものがあるかどうがテストします。マッチした場所のインデックスを返します。検索に失敗した場合-1を返します。**String** のメソッド |
| replace | 文字列中で一致するものを検索し、別の文字列に置き換えします。 |
| split   | 文字列を正規表現で分割し、部分文字列の配列をかえします。 |

#### RegExp.exec() メソッド

exec() メソッドを使うと、正規表現燐寸を実行します。結果の配列あるいは、null がかえります。マッチが成功した場合、配列を返し、正規表現オブジェクトのプロパティを更新します。
結果配列には、マッチした部分の、括弧で囲まれた部分文字列のマッチが格納されます。加えて、この配列は拡張プロパティを持っており、対象文字列がどこでマッチしたのかのインデックス情報等が設定されます。

以下のプログラムを実行してみます。
```javascript
// 正規表現で数字 と 小文字英字 のパターン
var re = /([0-9]+)([a-z]+)/g;
// 対象文字列
var str = "111jpy,8usd,xxx";

// 1回目実行
console.log(re.exec(str));
```
```bash
['111jpy', '111', 'jpy', index: 0, input: '111jpy,8usd,xxx']
```
```javascript
// 2回目実行
console.log(re.exec(str));
```
```bash
['8usd', '8', 'usd', index: 7, input: '111jpy,8usd,xxx']
```
```javascript
// 3回目実行
console.log(re.exec(str));
```
```bash
null
```
正規表現の `g` フラグを指定すると、パターンに一致するすべての結果を取り出すと言う意味になりますが、この場合は`exec()`メソッドを複数回呼び出すことで、複数の結果を得ることが出来ます。

#### RegExp.test() メソッド

正規表現パターンと対象文字列がマッチするかどうかを調べます。結果は、true か false の真偽値を返します。

```javascript
// 郵便番号 nnn-nnnn を表すパターン
var re = /^\d{3}-\d{4}$/;
```
値にマッチするかどうか調べる
```javascript
re.test("123-1234");
true
```
```javascript
re.test("12-1234");
false
```
```javascript
re.test("440-0011");
true
```
```javascript
re.test("aaa-bbb");
false
```

#### String.match() メソッド

文字列オブジェクトのメソッドで正規表現マッチを行います。
正規表現に`g`フラグを含んでいない場合、RegExp.exec() メソッドと同じ結果を返しますが、`g`フラグを含む場合は、マッチした部分をすべて含む配列を返します。マッチしなければ null を返します。
まずは、`g`フラグがあるかないかで結果の違いを確かめてみましょう

```javascript
// 対象文字列
var str = "v=20,n=40,c=30";
```
```javascript
// 数値をマッチ
str.match(/[0-9]+);
['20',
  index: 2,
  input: 'v=20,n=40,c=30']
```
```javascript
// すべての数値をマッチ
str.match(/[0-9]+/g);
['20', '40', '30']
```
```javascript
// 変数と値の組み合わせをマッチ
str.match(/\w+=\d+/g);
['v=20', 'n=40', 'c=30']
```

#### String.search() メソッド

対象文字列と正規表現パターンがマッチするか調べます
正規表現が見つかったらな、見つかったインデックスを返し、見つからなければ、-1 を返します。

```javascript
// 対象文字列
var str = "zip:999-9999, mail:a@example.com";
```
```javascript
// 郵便番号を検索
str.search(/\d{3}-\d{4}/);
4
```
```javascript
// メールアドレスを検索
str.search(/\w+\@\w+\.\w+/);
19
```
```javascript
// URLを検索
str.search(/https?:\/\//);
-1
```

#### String.replace() メソッド

正規表現による置換を行う、`replace()`メソッドについて
異なる書式が指定できるので順に見て行きましょう

```javascript
// 対象文字列
var str = "Today 10per OFF";
```
```javascript
// 数値を30に置換
str.replace(/\d+/, "30");
'Today 30per OFF'
```
```javascript
// 数値に続く英子文字を置換
str.replace(/\d+[a-z]+/, "500yen");
'Today 500yen OFF'
```
```javascript
// アルファベットを消して数字だけ残す
str.replace(/[a-zA-Z]+/g, "");
' 10 '
```

また、置換文字列の中には、特殊な置換パターンを含めることができます。

**置換文字列に使える特殊文字**
| パターン | 説明 |
|:--------|:-----|
| $$         | 「$」を挿入します |
| $&         | マッチした部分文字列を挿入します |
| $`         | マッチした部分文字列の直前の文字列を挿入します |
| $'         | マッチした部分文字列の直後の文字列を挿入します |
| $1$2$3 ... | 括弧でキャプチャされた部分文字列を挿入します |

```javascript
// 対象文字列
var str = "tel:045-111-222";
```
```javascript
// 先頭を括弧でくくる
str.replace(/(\d+)-(\d)-(\d)/, "($1)-($2)-($3)");
'tel:(045)-(111)-(222)'
```

次に、コールバック関数を利用した `replace()`の利用例

```javascript
// 対象文字列
var str = "piano GUITAR";

// 大文字を小文字に変換
str.replace(/[a-z]+/g, function(v){
	return v.toUpperCase();
});
```
```javascript
'PIANO GUITAR'
```

```javascript
// 対象文字列
var str = "price: 100yen";

// 値段をマッチさせて、税金8%を加算して置換
str.replace(/d+/, function(v){
	v = parseInt(v);
	return Math.ceil(1.08 * v);
});
```
```javascript
'price: 108yen'
```